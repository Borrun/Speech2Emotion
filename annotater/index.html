<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Speech2Emotion 标注工具</title>
  <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
  <style>
    :root { --primary: #446; --accent: #d64545; }
    body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background: #f8f9fa; color: #333; }
    .wrap { display: grid; grid-template-columns: 320px 1fr; height: 100vh; }
    .left { border-right: 1px solid #ddd; background: #fff; overflow-y: auto; }
    .hdr { padding: 15px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: #fff; z-index: 10; }
    .item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
    .item:hover { background: #f0f4f8; }
    .item.active { background: #eef6ff; border-left: 4px solid var(--primary); }
    .pill { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #eee; }
    .pill.ok { background: #e6f7e6; color: #2e7d32; }
    .right { padding: 20px; overflow-y: auto; }
    .info-bar { display: flex; gap: 20px; margin-bottom: 15px; background: #fff; padding: 10px 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    #waveContainer { background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 15px; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    #wave { position: relative; z-index: 1; border-radius: 4px; overflow: hidden; }
    #overlay { position: absolute; left: 15px; right: 15px; top: 15px; height: 160px; z-index: 5; pointer-events: auto; }
    #svg { width: 100%; height: 100%; display: block; overflow: visible; }
    .progress-box { margin-top: 15px; display: flex; align-items: center; gap: 15px; }
    #mainSlider { flex-grow: 1; cursor: pointer; }
    .time-label { min-width: 80px; font-variant-numeric: tabular-nums; font-weight: bold; color: var(--primary); }
    .controls { margin-top: 15px; display: flex; gap: 10px; }
    button { padding: 8px 16px; border: 1px solid #ccc; background: #fff; border-radius: 6px; cursor: pointer; font-weight: 500; }
    button:hover { background: #f0f0f0; border-color: #999; }
    #btnSave { background: var(--primary); color: #fff; border: none; }
    .panel { margin-top: 20px; display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; }
    .edit-area { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
    .preview-area { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #eee; text-align: center; }
    textarea { width: 100%; height: 80px; margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; resize: vertical; }
    #shapeSvg { width: 100%; height: 260px; background: #fafafa; border-radius: 8px; }
    .kbd { background: #eee; padding: 2px 4px; border-radius: 4px; font-size: 11px; }
    .legend { display: flex; gap: 12px; margin-top: 10px; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 5px; font-size: 12px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; }
    .hint-list { font-size: 12px; color: #666; margin-top: 10px; padding-left: 20px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <div class="hdr">
      <b>音频列表</b> 
      <span class="pill" id="countPill">0</span>
      <span class="pill ok" id="donePill">完成: 0</span>
    </div>
    <ul class="list" id="fileList"></ul>
  </div>

  <div class="right">
    <div class="info-bar">
      <div>当前: <b id="curName">未选择</b></div>
      <div class="pill">FPS: <span id="fps">30</span></div>
      <div class="pill">时长: <span id="durDisplay">0.00</span>s</div>
      <div class="pill">段数: <span id="ptCount">0</span></div>
    </div>

    <div id="waveContainer">
      <div id="wave"></div>
      <div id="overlay"><svg id="svg"></svg></div>
      <div class="progress-box">
        <input id="mainSlider" type="range" min="0" max="1000" value="0" step="1">
        <div class="time-label"><span id="curTime">0.00</span> / <span id="totalTime">0.00</span></div>
      </div>
    </div>

    <div class="controls">
      <button id="btnPlay">播放/暂停 <span class="kbd">Space</span></button>
      <button id="btnPrev">上一个 <span class="kbd">P</span></button>
      <button id="btnNext">下一个 <span class="kbd">N</span></button>
      <div style="flex-grow:1"></div>
      <button id="btnSave">保存标注</button>
      <button id="btnExport">导出 JSON</button>
    </div>

    <div class="panel">
      <div class="edit-area">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <b>标注设置</b>
          <select id="segType" style="padding:5px; border-radius:5px">
            <option value="happy">happy (1)</option>
            <option value="sad">sad (2)</option>
            <option value="angry">angry (3)</option>
            <option value="fear">fear (4)</option>
            <option value="calm" selected>calm (5)</option>
          </select>
        </div>
        <div id="typeLegend" class="legend"></div>
        <div style="margin-top:15px">
          <b>文本转写</b>
          <textarea id="audioText" placeholder="在此输入音频对应的文本内容..."></textarea>
        </div>
        <ul class="hint-list">
          <li><b>右键点击曲线空白处</b>：新增控制点</li>
          <li><b>左键拖动白点</b>：调整时间或强度等级</li>
          <li><b>Alt + 左键点击点</b>：删除该点</li>
          <li><b>点击曲线段</b>：将该区间设为选中的情绪类型</li>
        </ul>
      </div>
      <div class="preview-area">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px">
          <b>2D 表情预览</b>
          <span id="shapeDebug" style="font-size:12px; color:#888"></span>
        </div>
        <svg id="shapeSvg"></svg>
        <div style="font-size:12px; color:#999; margin-top:5px">同步帧: <span id="shapeFrame">—</span></div>
      </div>
    </div>
    <div id="err" style="color:red; margin-top:10px; font-size:14px"></div>
  </div>
</div>

<script>
  const FPS = 30;
  const LEVEL_MAPPING = {0:5, 1:18, 2:38, 3:68, 4:98, 5:130};
  const TYPES = ["happy","sad","angry","fear","calm"];
  const TYPE_COLORS = { happy: "#f6a21a", sad: "#5b7bd5", angry: "#d64545", fear: "#7a5bd5", calm: "#2e8b57" };

  let files = [], curIndex = -1, wavesurfer = null;
  let duration = 0, curve = [], selectedIndex = null, draggingIndex = null;
  let dragOffset = {dx:0, dy:0}, hoveredSeg = null;

  const elSvg = document.getElementById('svg');
  const elMainSlider = document.getElementById('mainSlider');
  const elCurTime = document.getElementById('curTime');
  const elTotalTime = document.getElementById('totalTime');
  const elShapeSvg = document.getElementById('shapeSvg');
  const elShapeFrame = document.getElementById('shapeFrame');

  function fetchJSON(url, opts) {
    return fetch(url, opts).then(r => r.ok ? r.json() : r.json().then(e => { throw e }));
  }

  function renderLegend() {
    const container = document.getElementById('typeLegend');
    container.innerHTML = TYPES.map(t => `
      <div class="legend-item">
        <span class="dot" style="background:${TYPE_COLORS[t]}"></span>
        <span>${t}</span>
      </div>
    `).join('');
  }
  renderLegend();

  function getOverlayDim() {
    const rect = document.getElementById('overlay').getBoundingClientRect();
    return { w: rect.width, h: rect.height };
  }

  const tToX = (t) => (t / (duration || 1)) * getOverlayDim().w;
  const xToT = (x) => Math.max(0, Math.min(duration, (x / getOverlayDim().w) * duration));
  const vToY = (v) => (1 - (v / 150)) * getOverlayDim().h;
  const yToV = (y) => Math.max(0, Math.min(150, (1 - (y / getOverlayDim().h)) * 150));

  function draw() {
    if (!elSvg) return;
    const { w, h } = getOverlayDim();
    elSvg.setAttribute("viewBox", `0 0 ${w} ${h}`);
    elSvg.innerHTML = "";

    Object.entries(LEVEL_MAPPING).forEach(([lvl, val]) => {
      const y = vToY(val);
      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", 0); line.setAttribute("x2", w);
      line.setAttribute("y1", y); line.setAttribute("y2", y);
      line.setAttribute("stroke", "#eee"); line.setAttribute("stroke-dasharray", "4");
      elSvg.appendChild(line);
    });

    for (let i = 0; i < curve.length - 1; i++) {
      const p1 = curve[i], p2 = curve[i+1];
      const x1 = tToX(p1.t), x2 = tToX(p2.t), y = vToY(p1.value);
      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", x1); line.setAttribute("x2", x2);
      line.setAttribute("y1", y); line.setAttribute("y2", y);
      line.setAttribute("stroke", TYPE_COLORS[p1.type] || "#333");
      line.setAttribute("stroke-width", hoveredSeg === i ? "12" : "8");
      line.style.cursor = "pointer";
      line.onclick = () => applyTypeToSeg(i, document.getElementById('segType').value);
      elSvg.appendChild(line);
      
      if (x2 - x1 > 40) {
        const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
        txt.setAttribute("x", (x1 + x2)/2); txt.setAttribute("y", y - 12);
        txt.setAttribute("text-anchor", "middle"); txt.setAttribute("font-size", "12");
        txt.setAttribute("font-weight", "bold"); txt.setAttribute("fill", TYPE_COLORS[p1.type]);
        txt.textContent = p1.type;
        elSvg.appendChild(txt);
      }
    }

    curve.forEach((p, i) => {
      const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circle.setAttribute("cx", tToX(p.t)); circle.setAttribute("cy", vToY(p.value));
      circle.setAttribute("r", i === selectedIndex ? 8 : 6);
      circle.setAttribute("fill", "#fff"); circle.setAttribute("stroke", "#333");
      circle.setAttribute("stroke-width", "2");
      circle.style.cursor = "grab";
      circle.onmousedown = (e) => {
        if (e.altKey) { deletePoint(i); return; }
        draggingIndex = i; selectedIndex = i;
        dragOffset = { dx: e.offsetX - tToX(p.t), dy: e.offsetY - vToY(p.value) };
        e.stopPropagation();
      };
      elSvg.appendChild(circle);
    });

    const playhead = document.createElementNS("http://www.w3.org/2000/svg", "line");
    const px = tToX(wavesurfer ? wavesurfer.getCurrentTime() : 0);
    playhead.setAttribute("x1", px); playhead.setAttribute("x2", px);
    playhead.setAttribute("y1", 0); playhead.setAttribute("y2", h);
    playhead.setAttribute("stroke", "red"); playhead.setAttribute("stroke-width", "2");
    playhead.setAttribute("id", "playhead");
    elSvg.appendChild(playhead);
  }

  function applyTypeToSeg(idx, type) { curve[idx].type = type; draw(); saveLabel(); }
  function deletePoint(i) { if (i === 0 || i === curve.length - 1) return; curve.splice(i, 1); draw(); saveLabel(); }
  function snapV(v) {
    let best = 5, minD = Infinity;
    Object.values(LEVEL_MAPPING).forEach(target => {
      if (Math.abs(v - target) < minD) { minD = Math.abs(v - target); best = target; }
    });
    return best;
  }

  async function updateShapePreview(t) {
    let segIdx = -1;
    for (let i = 0; i < curve.length - 1; i++) {
      if (t >= curve[i].t && t <= curve[i+1].t) { segIdx = i; break; }
    }
    if (segIdx === -1) return;
    const ty = curve[segIdx].type;
    const val = curve[segIdx].value;
    const frameNum = snapV(val);
    try {
      const data = await fetchJSON(`/api/emo_shape/${ty}?frame=${frameNum}`);
      renderShape(data.groups, ty);
      elShapeFrame.textContent = data.frame;
      document.getElementById('shapeDebug').textContent = `${ty} @ ${frameNum}`;
    } catch(e) {}
  }

  function renderShape(groups, currentType) {
    elShapeSvg.innerHTML = "";
    if (!groups) return;
    const processedGroups = groups.map((pts, i) => {
      if (!pts.length) return [];
      let newPts = pts.map(p => [p[0], -p[1]]);
      if (i === 2 || i === 3) {
        const cx = newPts.reduce((sum, p) => sum + p[0], 0) / newPts.length;
        const cy = newPts.reduce((sum, p) => sum + p[1], 0) / newPts.length;
        newPts = newPts.map(p => [cx + (p[0] - cx) * 0.6, cy + (p[1] - cy) * 0.6]);
      }
      return newPts;
    });
    let minX = 1e9, maxX = -1e9, minY = 1e9, maxY = -1e9;
    processedGroups.flat().forEach(([x, y]) => {
      minX = Math.min(minX, x); maxX = Math.max(maxX, x);
      minY = Math.min(minY, y); maxY = Math.max(maxY, y);
    });
    const pad = 20;
    elShapeSvg.setAttribute("viewBox", `${minX-pad} ${minY-pad} ${maxX-minX+pad*2} ${maxY-minY+pad*2}`);
    processedGroups.forEach((pts, i) => {
      if (!pts.length) return;
      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      const d = pts.map((p, j) => (j === 0 ? "M" : "L") + p.join(",")).join(" ");
      path.setAttribute("d", d);
      path.setAttribute("fill", "none");
      path.setAttribute("stroke", i === 0 ? "#ccc" : (TYPE_COLORS[currentType] || "#333"));
      path.setAttribute("stroke-width", "4"); 
      path.setAttribute("stroke-linecap", "round");
      path.setAttribute("stroke-linejoin", "round");
      elShapeSvg.appendChild(path);
    });
  }

  async function loadIndex(idx) {
    if (idx < 0 || idx >= files.length) return;
    curIndex = idx;
    const file = files[idx];
    document.getElementById('curName').textContent = file.wav;
    if (wavesurfer) wavesurfer.destroy();
    wavesurfer = WaveSurfer.create({
      container: '#wave', height: 160, waveColor: '#ccc', progressColor: '#446',
      url: `/audio/${encodeURIComponent(file.wav)}`, interact: true
    });

    wavesurfer.on('ready', async () => {
      duration = wavesurfer.getDuration();
      elTotalTime.textContent = duration.toFixed(2);
      document.getElementById('durDisplay').textContent = duration.toFixed(2);
      
      const lbl = await fetchJSON(`/api/label/${encodeURIComponent(file.wav)}`);
      
      // 默认生成一条从头到尾的 calm 0 情绪线
      if (!lbl.curve || lbl.curve.length < 2) {
        curve = [
          { t: 0, type: "calm", value: 5 },
          { t: duration, type: "calm", value: 5 }
        ];
      } else {
        curve = lbl.curve;
      }

      document.getElementById('audioText').value = lbl.text || "";
      document.getElementById('ptCount').textContent = curve.length;
      draw();
      updateShapePreview(0);
      renderList();
    });

    wavesurfer.on('timeupdate', (t) => {
      elCurTime.textContent = t.toFixed(2);
      elMainSlider.value = (t / duration) * 1000;
      updateShapePreview(t);
      const ph = document.getElementById('playhead');
      if (ph) ph.setAttribute("x1", tToX(t)), ph.setAttribute("x2", tToX(t));
    });
  }

  elMainSlider.oninput = () => wavesurfer.setTime((elMainSlider.value / 1000) * duration);

  window.onmousemove = (e) => {
    if (draggingIndex === null) return;
    const { left, top } = document.getElementById('overlay').getBoundingClientRect();
    let t = xToT(e.clientX - left - dragOffset.dx);
    let v = yToV(e.clientY - top - dragOffset.dy);
    if (draggingIndex === 0) t = 0;
    else if (draggingIndex === curve.length-1) t = duration;
    else t = Math.max(curve[draggingIndex-1].t + 0.01, Math.min(curve[draggingIndex+1].t - 0.01, t));
    curve[draggingIndex].t = t;
    curve[draggingIndex].value = snapV(v);
    draw();
  };

  window.onmouseup = () => { if (draggingIndex !== null) { draggingIndex = null; saveLabel(); } };

  elSvg.oncontextmenu = (e) => {
    e.preventDefault();
    const t = xToT(e.offsetX), v = snapV(yToV(e.offsetY));
    curve.push({ t, value: v, type: document.getElementById('segType').value });
    curve.sort((a,b) => a.t - b.t);
    draw(); saveLabel();
  };

  async function saveLabel() {
    if (curIndex < 0) return;
    const payload = { wav: files[curIndex].wav, fps: FPS, duration, curve, text: document.getElementById('audioText').value };
    await fetchJSON('/api/save', { method:'POST', body: JSON.stringify(payload) });
    files[curIndex].labeled = true;
    document.getElementById('ptCount').textContent = curve.length;
    renderList();
  }

  function renderList() {
    const list = document.getElementById('fileList');
    list.innerHTML = files.map((f, i) => `
      <li class="item ${i === curIndex ? 'active' : ''}" onclick="loadIndex(${i})">
        <span style="font-size:13px">${f.wav}</span>
        <span class="pill ${f.labeled ? 'ok' : ''}">${f.labeled ? '✓' : ''}</span>
      </li>
    `).join('');
    document.getElementById('countPill').textContent = files.length;
    document.getElementById('donePill').textContent = `完成: ${files.filter(f => f.labeled).length}`;
  }

  document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'TEXTAREA') return;
    if (e.code === 'Space') { e.preventDefault(); wavesurfer.playPause(); }
    if (e.key === 'p') loadIndex(curIndex - 1);
    if (e.key === 'n') loadIndex(curIndex + 1);
    if (["1","2","3","4","5"].includes(e.key)) document.getElementById('segType').value = TYPES[parseInt(e.key)-1];
  });

  window.onresize = () => draw();
  fetchJSON('/api/files').then(data => { files = data; renderList(); if(data.length) loadIndex(0); });
  document.getElementById('btnPlay').onclick = () => wavesurfer.playPause();
  document.getElementById('btnSave').onclick = () => saveLabel();
  document.getElementById('btnPrev').onclick = () => loadIndex(curIndex - 1);
  document.getElementById('btnNext').onclick = () => loadIndex(curIndex + 1);
  document.getElementById('btnExport').onclick = async () => {
    const data = await fetchJSON(`/api/export/${encodeURIComponent(files[curIndex].wav)}`);
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${files[curIndex].wav.split('.')[0]}.json`;
    a.click();
  };
</script>
</body>
</html>